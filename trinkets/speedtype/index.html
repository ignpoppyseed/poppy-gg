<!DOCTYPE html>
<head>
    <title>speedtype</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/media/styles/style.css">
    <style>
        #game {
            display: grid;
            /* grid-template-rows: 0.3fr 1fr; */
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: max-content
        }
        #game > * { width: 100%; }
        #input:focus { outline: none; }
        #timer { font-size: xx-large; margin: 0; }
        #final_score { font-size: xx-large; margin: 0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="header">
            <img src="/media/head.gif">
            <nav>
                <ul>
                    <li><a href="/">home</a></li>
                    <li><a href="/trinkets" class="active">trinkets</a></li>
                    <li><a href="/cave">cave</a></li>
                    <li><a href="/buttons">buttons</a></li>
                    <li><a href="https://poppy.atabook.org/" target="_blank">guestbook &#129125;</a></li>
                    <li><a href="https://spacehey.com/poppies" target="_blank">spacehey &#129125;</a></li>
                    <li><a href="http://blog.scsi.cloud" target="_blank">blog &#129125;</a></li>
                </ul>
            </nav>
        </div>
        <div id="content">
            <div id="pregame">
                <center>
                    <label for="user_game_length">game length in seconds: </label>
                    <input type="number" value="60" id="user_game_length"><br>
                    <button onclick="start_game()">start game !!!</button>
                </center>
            </div>
            <div id="postgame" class="hidden">
                <center>
                    <p id="final_score"></p>
                    <button onclick="window.location = window.location">reset</button>
                </center>
            </div>
            <div id="game" class="hidden">
                <div style="grid-area: 1/1/1/3;">
                    <center><p id="timer">00:00</p></center>
                </div>
                <div style="grid-area: 2/1/2/1;" id="copy"></div>
                <div id="input" style="grid-area: 2/2/2/2;" contenteditable="true"></div>
            </div>
        </div>
    </div>
    <footer>
        <center>
            <p>copyright poppy 2025</p>
            <a href="https://poppy.gg">
                <img src="/media/button/poppy.gg.gif">
                <img src="/media/button/gec.gif">
            </a>
        </center>
    </footer>
</body>
<script src="/media/scripts/words.js"></script>
<script>
    const game_length_input = document.getElementById('user_game_length')
    // const default_game_length = 300 // game length in seconds
    const pregame = document.getElementById('pregame'), game = document.getElementById('game'), postgame = document.getElementById('postgame'), copy = document.getElementById('copy'), input = document.getElementById('input'), timer = document.getElementById('timer'), final_score = document.getElementById('final_score')
    function start_game() {
        const game_length = parseInt(game_length_input.value)
        const init_time = Date.now()
        pregame.classList.add('hidden')
        copy.innerText = generate_copy()
        game.classList.remove('hidden')
        timer.innerText = format_seconds(game_length)
        var timer_interval = setInterval(function() {
            var time_left = Math.floor(game_length - ((Date.now() - init_time) / 1000))
            timer.innerText = format_seconds(time_left)
            if (time_left < 1) { clearInterval(timer_interval); game_end() }
        }, 1000);
    }

    function game_end() {
        input.contentEditable = 'false'
        postgame.classList.remove('hidden')
        timer.classList.add('hidden')
        final_score.innerText = `final score: ${calculate_score()}`
    }

    function calculate_score() {
        return `${Math.floor((input.innerText.length*100)/copy.innerText.length)}%`
    }

    function generate_copy() {
        var counter = 0
        var text_list = []
        while (counter < 100+1) {
            if (Math.floor(Math.random() * 10) == 1) {
                text_list.push(ext_word_list[Math.floor(Math.random() * ext_word_list.length)]+['?', '.', '!'][Math.floor(Math.random() * 3)])
            } else {
                text_list.push(ext_word_list[Math.floor(Math.random() * ext_word_list.length)])
            }
            counter++
        }
        return text_list.join(' ')+['?', '.', '!'][Math.floor(Math.random() * 3)]
    }

    function format_seconds(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remaining_seconds = seconds % 60;

        const formatted_minutes = String(minutes).padStart(2, '0');
        const formatted_seconds = String(remaining_seconds).padStart(2, '0');

        return `${formatted_minutes}:${formatted_seconds}`;
    }

    input.onkeyup = function(e) {
        console.log(e.key)
        if (!copy.innerText.startsWith(input.innerText) && e.key != ' ') { input.innerText = '' }
    }
</script>